import groovy.json.JsonSlurper

// 组件化切换
task component << {
    String sign = "// generate by _component.gradle, do not modify!\n"

    // check .component.json exist
    File pkgJsonFile = new File(".component.json")
    if (!pkgJsonFile.exists()) {
        pkgJsonFile.createNewFile()
        pkgJsonFile.write("""
// 组件化配置文件，修改下面的内容，运行 gradlew component 重新构建
{
  "entry": "main",
  "components": [
    {
      "name": "main",
      "compile": true,
      "remote: false,
      "remotePath": "",
      "path": "component_main",
      "entry": "",
    }
  ]
}""", "utf-8")
        throw new RuntimeException("please update .component.json first")
    }

    // read component config
    def pkgConfig = new JsonSlurper().parseText(pkgJsonFile.text)

    // 配置 setting.gradle
    File settingGradleFile = touchFile("settings.gradle")
    if (!settingGradleFile.text.contains(sign)) {
        settingGradleFile.append("${sign}apply from: '.component_setting.gradle'")
    }

    // 打印消息
    String logContent = ""
    // 组件化配置文件，配置组件入口等
    File configFile = touchFile(".component_config.gradle")
    // 组件化依赖文件，动态组件依赖
    File depsFile = touchFile(".component_deps.gradle")
    String depsContent = "\n"
    // 组件化 settings 文件，动态添加编译
    File settingFile = touchFile(".component_setting.gradle")
    String settingContent = ""
    String entry = ""
    for (component in pkgConfig.components) {
        if (pkgConfig.entryComponent == component.name) {
            entry = component.entry
        }
        if (component.compile) {
            if (component.remote) {
                depsContent += "  runtimeOnly '${component.remotePath}'\n"
            } else {
                settingContent += "include(':${component.path}')\n"
                depsContent += "  runtimeOnly project(':${component.path}')\n"
            }
        }
        logContent += "组件 => ${component.name} | ${component.compile ? '' : '不'}参与编译 | 路径 => ${component.path}\n"
    }

    log("""
配置文件详情如下：
入口组件：${entry}
${logContent}
""")

    // 文件写入
    settingFile.write("${sign}${settingContent}", "utf-8")
    configFile.write("""${sign}ext.component = [ entry: '${entry}' ]""", "utf-8")
    depsFile.write("""${sign}dependencies {${depsContent}}""", "utf-8")
}

static File touchFile(String name) {
    File file = new File(name)
    if (!file.exists()) {
        file.createNewFile()
    }
    return file
}

static def log(msg) {
    println(msg)
}